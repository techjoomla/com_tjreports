/*
 * @package     Tjreports.Plugins
 * @subpackage  Plugins,system,plg_system_sendemail
 *
 * @author      Techjoomla <extensions@techjoomla.com>
 * @copyright   Copyright (C) 2009 - 2020 Techjoomla. All rights reserved.
 * @license     GNU General Public License version 2 or later; see LICENSE.txt
 */
jQuery(document).ready(function(){tjutilitysendemail.tjTdClass=".td-sendemail",tjutilitysendemail.tjTableId="report-table",tjutilitysendemail.initialize(),jQuery("body").find(tjutilitysendemail.tjTdClass).length&&tjutilitysendemail.loadTinymce()});var tjutilitysendemail={loadTinymce:function(){tinymce.remove(),tinymce.init({selector:"textarea#email-message",setup:function(e){e.on("change",function(){tinymce.triggerSave()})}})},initialize:function(){var e=jQuery("body").find(tjutilitysendemail.tjTdClass).length,a=jQuery("body").find('input[name="cid[]"]').length;e&&(a||this.addColumn(),this.btnSendEmail())},addColumn:function(){document.getElementById(tjutilitysendemail.tjTableId).tHead.children[0].insertCell(0).outerHTML='<th><input type="checkbox" name="checkall-toggle" value="" class="hasTooltip" title="Check All Items" onclick="Joomla.checkAll(this)"></th>';for(var e=document.getElementById(tjutilitysendemail.tjTableId).tBodies[0],a=0;a<e.rows.length;a++){e.rows[a].insertCell(0).innerHTML='<input type="checkbox" id="cb0" name="cid[]" value="'+a+'" onclick="Joomla.isChecked(this.checked);">'}},btnSendEmail:function(){try{let e='<div class="btn-wrapper" id="tj-sendemail">';e+='<button type="button" class="btn btn-primary" id="email-queue-column" data-toggle="modal" data-target="#bulkEmailModal" onclick="tjutilitysendemail.openEmailPopup();">',e+=Joomla.JText._("PLG_SYSTEM_SENDEMAIL_BTN"),e+="</button>",e+="</div>",jQuery("#sendEmail").append(e)}catch(e){}},openEmailPopup:function(){try{tjutilitysendemail.loadTinymce();if(0==document.adminForm.boxchecked.value)return alert(Joomla.JText._("PLG_SYSTEM_SENDEMAIL_SELECT_CHECKBOX")),!1;jQuery("div").find(".tjlms-wrapper").removeClass("tjBs3");var e='<div id="bulkEmailModal" class="custom-modal modal fade" role="dialog">';e+='<div class="modal-dialog modal-lg">',e+='<div class="modal-content is-progress" id="emailPopup">',e+='<div id="preload"></div>',e+='<div class="modal-header">',e+='<h5 class="modal-title d-inline-block fs-18 font-600" id="exampleModalLabel">'+Joomla.JText._("PLG_SYSTEM_SENDEMAIL_POPUP_HEADING")+"</h5>",e+='<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>',e+='<span id="errorMessage"></span>',e+="</div>",e+='<div class="modal-body">',e+='<div class="container-fluid">',e+='<form action="#" method="post" enctype="multipart/form-data" name="emailTemplateForm" id="emailTemplateForm" class="form-validate">',e+='<div class="row">',e+='<div class="col-sm-12">',e+='<div class="control-group">',e+='<div class="control-label">',e+='<label id="email-subject-label" for="email-subject" class="hasPopover required" title="" >',e+=Joomla.JText._("PLG_SYSTEM_SENDEMAIL_POPUP_EMAIL_SUBJECT")+' <span class="star">&nbsp;*</span>',e+="</label>",e+="</div>",e+='<div class="controls">',e+='<input type="text" name="template[subject]" id="email-subject" value="" class="required w-100" required="required" aria-required="true">',e+="</div>",e+="</div>",e+='<div class="control-group">',e+='<div class="control-label">',e+='<label id="email-message-label" for="email-message" class="hasPopover required" title="" >',e+=Joomla.JText._("PLG_SYSTEM_SENDEMAIL_POPUP_EMAIL_BODY_MESSAGE")+' <span class="star">&nbsp;*</span>',e+="</label>",e+="</div>",e+='<div class="controls">',e+='<textarea name="template[message]" rows="7" style="width: 30%;" id="email-message" value="" class="required" required="required" aria-required="true"></textarea>',e+="</div>",e+="</div>",e+="</div>",e+='<div id="emailsDiv"></div>',e+="</div>",e+="</div>",e+="</form>",e+="</div>",e+='<div class="modal-footer">',e+='<button type="button" class="btn btn-primary validate" id="send-email" onclick="tjutilitysendemail.validate();">'+Joomla.JText._("PLG_SYSTEM_SENDEMAIL_POPUP_SEND_BTN")+"</button>",e+="</div>",e+="</div>",e+="</div>",e+="</div>",jQuery("#bulkEmailModal").hasClass("custom-modal")||jQuery("#j-main-container").append(e),jQuery("div").find("#preload").hide(),jQuery("div").find(".is-progress").removeClass("is-progress"),jQuery("div").find("#send-email").attr("disabled",!1),jQuery("#email-subject").val("");var a=new Array;jQuery("#emailsDiv").empty(),jQuery.each(jQuery("input[name='cid[]']:checked").closest("td").siblings("td"+tjutilitysendemail.tjTdClass),function(){a.push(jQuery(this).text());var e="<input readonly type='hidden' name='emails[]' value='"+jQuery(this).text()+"'/>";jQuery("#bulkEmailModal").find("#emailsDiv").append(e)}),tinyMCE.execCommand("mceAddEditor",!1,"email-message")}catch(e){alert(e.message)}},validate:function(){var e=jQuery("#email-subject").val(),a=jQuery("#email-message").val(),i=0;if(jQuery("#errorMessage").empty(),e)jQuery("#email-subject").removeClass("invalid"),jQuery("#email-subject-label").removeClass("invalid");else{i=1,jQuery("#email-subject").addClass("invalid"),jQuery("#email-subject-label").addClass("invalid");var l='<div class="alert alert-error alert-danger"><button type="button" data-dismiss="alert" class="close">×</button><h4 class="alert-heading"></h4><div>Field required: Subject</div></div>';jQuery("#bulkEmailModal").find("#errorMessage").append(l)}if(a)jQuery("#email-message").removeClass("invalid"),jQuery("#email-message-label").removeClass("invalid");else{i=1,jQuery("#email-message").addClass("invalid"),jQuery("#email-message-label").addClass("invalid");l='<div class="alert alert-error alert-danger"><button type="button" data-dismiss="alert" class="close">×</button><h4 class="alert-heading"></h4><div>Field required: Message</div></div>';jQuery("#bulkEmailModal").find("#errorMessage").append(l)}if(i)return!1;jQuery("#preload").show(),jQuery("div").find("#emailPopup").addClass("is-progress"),jQuery("#send-email").attr("disabled",!0);var t=jQuery("#emailTemplateForm").serializeArray(),s=t.splice(0,2),d=(t=t.map(JSON.stringify).reverse().filter(function(e,a,i){return-1===i.indexOf(e,a+1)}).reverse().map(JSON.parse)).map(function(e,a){return a%5==0?t.slice(a,a+5):null}).filter(function(e){return e}),r=d.length;jQuery.each(d,function(e,a){var i=a.concat(s);tjutilitysendemail.send(i,e,r)})},send:function(e,a,i){a++;var l=Joomla.getOptions("system.paths").base+"index.php?option=com_ajax&plugin=plg_System_Sendemail&format=json";jQuery.ajax({url:l,type:"POST",async:!0,data:e,dataType:"json"}).fail(function(e){var a='<div class="alert alert-error alert-danger"><button type="button" data-dismiss="alert" class="close">×</button><h4 class="alert-heading"></h4><div>'+e.message+"</div></div>";jQuery("#bulkEmailModal").find("#errorMessage").append(a),jQuery("#preload").hide()}).done(function(e){a==i&&(jQuery("#preload").hide(),jQuery("div").find(".is-progress").removeClass("is-progress"),jQuery("#bulkEmailModal").modal("hide"),jQuery("div").find(".tjlms-wrapper").addClass("tjBs3"),Joomla.renderMessages({success:[e.message]}))})}};
